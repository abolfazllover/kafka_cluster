# راه‌انداز کلاستر Kafka (Ubuntu / KRaft)

این پروژه یک اسکریپت تعاملی برای راه‌اندازی کلاستر **Apache Kafka در حالت KRaft (بدون ZooKeeper)** روی اوبونتو/دبیان است.

## پیش‌نیازها

- اوبونتو/دبیان
- دسترسی `sudo`
- دسترسی اینترنت برای دانلود Kafka از Apache

## اجرا

1) فایل را اجرایی کنید:

```bash
chmod +x ./kafka-cluster.sh
```

2) اجرا با روت:

```bash
sudo ./kafka-cluster.sh
```

## منو

### بخش نصب و راه‌اندازی
1. **نصب/آماده‌سازی**: 
   - چک پیش‌نیازهای سیستم (دیسک، RAM، اینترنت)
   - نصب Java 17 + ابزارهای لازم
   - دانلود Kafka با چک SHA512
   - ساخت کاربر و سرویس systemd
   - رفع خودکار مشکلات رایج نصب

2. **راه‌اندازی سرور اولیه (Primary)**:
   - تولید `Cluster ID`
   - تنظیم نود اول
   - فرمت storage
   - راه‌اندازی سرویس

3. **راه‌اندازی سرور کمکی (Secondary)**:
   - اضافه کردن نود به کلاستر موجود
   - استفاده از `Cluster ID` مشترک

### بخش مانیتورینگ و عیب‌یابی
4. **مشاهده وضعیت کلاستر**: 
   - وضعیت سرویس
   - پورت‌های باز
   - اطلاعات نود
   - وضعیت Quorum
   - لیست Topics
   - منابع سیستم

5. **تست سلامت کامل (Health Check)**:
   - چک 10 معیار مهم
   - امتیازدهی سلامت کلاستر
   - تشخیص سریع مشکلات

6. **عیب‌یابی جامع با رفع خودکار**:
   - چک و رفع فضای دیسک
   - چک و رفع مشکلات حافظه
   - تشخیص و kill پروسه‌های اشغال‌کننده پورت
   - رفع مشکلات دسترسی فایل‌ها
   - بررسی تنظیمات نادرست
   - تست اتصال به سایر نودها
   - چک و نصب Java
   - بررسی لاگ‌ها برای خطاهای رایج
   - همگام‌سازی زمان سیستم
   - رفع خودکار ulimit و lock files

7. **تست تولید و مصرف پیام**:
   - تست واقعی Producer/Consumer
   - ایجاد topic تست
   - ارسال و دریافت پیام

### بخش مدیریت
8. **نمایش خلاصه تنظیمات**: نمایش فیلدهای مهم config

9. **پشتیبان‌گیری از تنظیمات**: backup خودکار فایل‌های config

10. **Start/Stop/Restart سرویس**: مدیریت سرویس systemd

11. **ریست نود (خطرناک)**: پاک‌کردن کامل دیتا و config (با backup خودکار)

## حداقل ورودی‌های لازم برای کلاستر

برای کلاستر واقعی (چندنودی) باید این موارد را بدانید:

- **node.id** یکتا برای هر نود
- **controller.quorum.voters** یک رشته مشترک بین همه نودها مثل:
  - `1@10.0.0.1:9093,2@10.0.0.2:9093,3@10.0.0.3:9093`
- **bind_ip** (بهتر است IP خصوصی همان سرور باشد)
- **advertised_host** (نام DNS یا IP که سایر نودها/کلاینت‌ها واقعاً به آن دسترسی دارند)

> توصیه: برای quorum حداقل **۳ نود** داشته باشید.

## امنیت

اسکریپت چند کار امنیتی پایه انجام می‌دهد:

- اجرای Kafka با کاربر محدود `kafka`
- سخت‌گیری systemd (ProtectSystem, NoNewPrivileges, …)
- فعال‌سازی Authorizer و جلوگیری از «همه‌چیز آزاد» (`allow.everyone.if.no.acl.found=false`)
- (اختیاری) افزودن قوانین UFW برای محدود کردن دسترسی به subnet مشخص

### نکته مهم درباره TLS

این اسکریپت به صورت پیش‌فرض **TLS/SSL** تولید نمی‌کند (چون گواهی معتبر معمولاً نیازمند CA/PKI سازمانی است).
اگر امنیت شبکه/اینترنت برایتان حیاتی است، توصیه می‌شود:

- Kafka را پشت شبکه خصوصی/VPN قرار دهید
- یا TLS را با گواهی معتبر و تنظیمات کامل فعال کنید

## فایل‌ها/مسیرهای مهم

- تنظیمات Kafka: `/etc/kafka/server.properties`
- cluster id: `/etc/kafka/cluster.id`
- دیتا: `/var/lib/kafka`
- لاگ سرویس: `journalctl -u kafka`
- سرویس: `systemctl status kafka`

## ویژگی‌های رفع خودکار خطا

اسکریپت قابلیت تشخیص و رفع خودکار این مشکلات را دارد:

### در بخش نصب:
- ✓ چک و هشدار فضای دیسک ناکافی
- ✓ چک و هشدار RAM کم
- ✓ تست و رفع مشکلات دسترسی اینترنت
- ✓ رفع DNS نادرست (افزودن nameserver عمومی)
- ✓ حذف lock files قدیمی apt
- ✓ retry خودکار برای دانلود‌های ناموفق
- ✓ استفاده از mirror های مختلف Apache
- ✓ چک SHA512 برای امنیت فایل دانلود شده

### در بخش عیب‌یابی:
- ✓ تشخیص و پاک‌کردن لاگ‌های قدیمی (دیسک پر)
- ✓ تشخیص OutOfMemoryError و افزایش خودکار heap
- ✓ تشخیص و kill پروسه‌های اشغال‌کننده پورت
- ✓ رفع خودکار permission های نادرست
- ✓ restart خودکار سرویس failed
- ✓ فعال‌سازی NTP برای همگام‌سازی زمان
- ✓ رفع ulimit پایین
- ✓ حذف lock files داخل data directory
- ✓ reset کردن سرویس‌های failed در systemd

## سناریوهای رایج استفاده

### سناریو 1: راه‌اندازی کلاستر 3 نودی از صفر

**روی سرور اول (10.0.0.1):**
```bash
sudo ./kafka-cluster.sh
# انتخاب: 1 (نصب)
# انتخاب: 2 (Primary)
# node.id: 1
# bind_ip: 10.0.0.1
# advertised_host: 10.0.0.1
# quorum.voters: 1@10.0.0.1:9093,2@10.0.0.2:9093,3@10.0.0.3:9093
# یادداشت کنید: Cluster ID
```

**روی سرور دوم (10.0.0.2):**
```bash
sudo ./kafka-cluster.sh
# انتخاب: 1 (نصب)
# انتخاب: 3 (Secondary)
# Cluster ID: [از سرور اول]
# node.id: 2
# bind_ip: 10.0.0.2
# advertised_host: 10.0.0.2
# quorum.voters: 1@10.0.0.1:9093,2@10.0.0.2:9093,3@10.0.0.3:9093
```

**روی سرور سوم (10.0.0.3):**
```bash
# مشابه سرور دوم با node.id: 3
```

### سناریو 2: عیب‌یابی کلاستر با مشکل

```bash
sudo ./kafka-cluster.sh
# انتخاب: 5 (Health Check) - برای دیدن امتیاز کلی
# انتخاب: 6 (عیب‌یابی جامع) - برای رفع خودکار مشکلات
# انتخاب: 7 (تست Producer/Consumer) - برای تست عملکرد
```

### سناریو 3: پورت 9092 اشغال است

```bash
sudo ./kafka-cluster.sh
# انتخاب: 6 (عیب‌یابی)
# اسکریپت پروسه اشغال‌کننده را نشان می‌دهد
# پرسیده می‌شود: آیا kill شود? yes
# مشکل حل می‌شود
```

### سناریو 4: دیسک پر شده

```bash
sudo ./kafka-cluster.sh
# انتخاب: 6 (عیب‌یابی)
# اسکریپت تشخیص می‌دهد دیسک >90% پر است
# پرسیده می‌شود: لاگ‌های +7 روز حذف شوند? yes
# فضا آزاد می‌شود
```

## ریست نود (خطرناک)

گزینه 11 (**ریست نود**) دیتا و تنظیمات نود را پاک می‌کند. قبل از ریست، backup خودکار تهیه می‌شود.

## لاگ‌ها و عیب‌یابی دستی

```bash
# لاگ اسکریپت bootstrap
tail -f /var/log/kafka-bootstrap.log

# لاگ سرویس Kafka
journalctl -u kafka -f

# چک وضعیت سرویس
systemctl status kafka

# چک پورت‌ها
ss -lntp | grep -E '9092|9093'

# دیدن فایل تنظیمات
cat /etc/kafka/server.properties
```

## سوالات متداول (FAQ)

**س: چرا Kafka start نمی‌شود؟**
ج: از گزینه 6 (عیب‌یابی جامع) استفاده کنید تا مشکل را خودکار تشخیص دهد.

**س: چطور می‌توانم TLS فعال کنم؟**
ج: باید دستی گواهی‌ها بسازید و تنظیمات TLS را به server.properties اضافه کنید.

**س: آیا می‌توانم روی یک سرور تست کنم؟**
ج: بله، در تنظیمات Primary از 127.0.0.1 استفاده کنید و quorum.voters فقط یک نود باشد.

**س: حداقل منابع سخت‌افزاری چقدر است؟**
ج: حداقل 2GB RAM، 10GB دیسک آزاد. برای production حداقل 4GB RAM و 50GB SSD توصیه می‌شود.


